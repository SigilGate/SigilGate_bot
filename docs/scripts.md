# Справочник скриптов

Бот использует скрипты из репозитория `scripts` как исполнительный слой.
Бот **не реализует** логику операций — он только вызывает скрипты, контролируя
доступ на основе ролей и статусов.

## Архитектура скриптов

Каждая группа операций содержит два уровня:

- **Атомарный скрипт** (`create`, `modify`, `delete`, `get`, `list`) — одна операция,
  без коммита в реестр. Пишет результат в `stdout`, логи — в `stderr`.
- **Оркестратор** (`add`, `update`, `remove`, `deactivate`) — цепочка: атомарный скрипт + операции
  на Entry-нодах + коммит в реестр.

Бот преимущественно вызывает **оркестраторы** для операций записи и **атомарные** для чтения.

**Модули:** `users/`, `devices/`, `nodes/`, `entry/`, `store/`

---

## Переменные окружения

| Переменная | Описание |
|---|---|
| `SIGIL_STORE_PATH` | Путь к локальному хранилищу реестра |
| `SIGIL_SSH_KEY` | Путь к SSH-ключу для Entry-нод |
| `SIGIL_SSH_USER` | SSH-пользователь на Entry-нодах |
| `SIGIL_SSH_PASSWORD` | Пароль sudo на Entry-нодах |

---

## users/

### `users/create.sh` [атомарный]

Создаёт запись пользователя в реестре. Не коммитит.

| Параметр | Обязательный | Описание | Валидация |
|---|---|---|---|
| `--username` | да | Имя пользователя | непустое, уникальное |
| `--core-node` | нет | IP Core-ноды | должна существовать и иметь статус active |
| `--email` | нет | Email | формат `*@*.*` |
| `--telegram` | нет | Telegram username | начинается с `@` |
| `--telegram-id` | нет | Telegram ID | положительное целое, уникальное |
| `--hash` | нет | Хеш пароля | любая строка |
| `--status` | нет | Статус | `active` (по умолчанию), `inactive`, `archived` |

**Возвращает:** ID созданного пользователя (целое число) в `stdout`.

**Создаёт JSON:**
```json
{
  "id": 6,
  "username": "Alice",
  "status": "inactive",
  "hash": null,
  "email": null,
  "telegram": "@alice",
  "telegram_id": 123456789,
  "core_nodes": [],
  "created": "2026-02-20"
}
```

---

### `users/add.sh` [оркестратор]

`create.sh` + коммит в реестр. Параметры те же, что у `create.sh`,
но `--username` и `--core-node` обязательны.

---

### `users/modify.sh` [атомарный]

Изменяет поля существующего пользователя. Не коммитит.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--id` | да | ID пользователя |
| `--username` | нет | Новое имя (уникальность проверяется) |
| `--status` | нет | `active`, `inactive`, `archived` |
| `--email` | нет | Новый email; пустая строка → `null` |
| `--telegram` | нет | Новый username; пустая строка → `null` |
| `--telegram-id` | нет | Новый ID; пустая строка → `null` |
| `--hash` | нет | Новый хеш; пустая строка → `null` |
| `--add-core-node` | нет | Добавить IP в `core_nodes[]` (идемпотентно) |
| `--remove-core-node` | нет | Удалить IP из `core_nodes[]` |

---

### `users/update.sh` [оркестратор]

`modify.sh` + коммит. Параметры те же.

---

### `users/delete.sh` [атомарный]

Удаляет запись пользователя. Не коммитит.
Отказывает если у пользователя есть устройства (необходимо сначала удалить их).
Идемпотентен: если пользователь не существует — `exit 0`.

| Параметр | Обязательный |
|---|---|
| `--id` | да |

---

### `users/remove.sh` [оркестратор]

Полное удаление пользователя: снимает все его устройства со всех Entry-нод,
удаляет записи устройств, удаляет запись пользователя, коммитит одним коммитом.

| Параметр | Обязательный |
|---|---|
| `--id` | да |

---

### `users/get.sh` [атомарный]

Возвращает полный JSON пользователя в `stdout`.

| Параметр | Обязательный |
|---|---|
| `--id` | да |

---

### `users/list.sh` [атомарный]

Возвращает JSON-массив пользователей в `stdout`.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--status` | нет | Фильтр: `active`, `inactive`, `archived` |

**Возвращает:**
```json
[
  {"id": 1, "username": "AlexMa", "status": "active"},
  {"id": 5, "username": "Tiger", "status": "inactive"}
]
```

---

## devices/

### `devices/create.sh` [атомарный]

Создаёт запись устройства в реестре. Не коммитит, не добавляет на Entry-ноды.

| Параметр | Обязательный | Описание | Валидация |
|---|---|---|---|
| `--user` | да | ID пользователя | пользователь должен существовать и иметь `status=active` |
| `--device` | да | Имя устройства | непустое |
| `--status` | нет | Статус устройства | `active` (по умолчанию), `inactive`, `archived` |

> **Примечание:** требует `status=active` у пользователя.
> Нельзя создать устройство для `inactive`-пользователя.

**Возвращает:** UUID созданного устройства в `stdout`.

---

### `devices/add.sh` [оркестратор]

`create.sh` + коммит + добавление UUID в Xray на всех Entry-нодах,
доступных пользователю (через `nodes/list-entry.sh --user`).

Параметры те же, что у `create.sh`.

---

### `devices/modify.sh` [атомарный]

Изменяет поля устройства. Не коммитит, не синхронизирует с Entry-нодами.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--uuid` | да | UUID устройства |
| `--device` | нет | Новое имя |
| `--status` | нет | `active`, `inactive`, `archived` |

---

### `devices/update.sh` [оркестратор]

`modify.sh` + коммит. Параметры те же. Не синхронизирует с Entry-нодами.

---

### `devices/delete.sh` [атомарный]

Удаляет запись устройства из реестра. Не коммитит, не снимает с Entry-нод.
Идемпотентен: если устройство не существует — `exit 0`.

| Параметр | Обязательный |
|---|---|
| `--uuid` | да |

---

### `devices/remove.sh` [оркестратор]

Полное удаление устройства: снимает UUID со всех Entry-нод (через `nodes/list-entry.sh --user`),
удаляет запись из реестра, коммитит.

| Параметр | Обязательный |
|---|---|
| `--uuid` | да |

---

### `devices/deactivate.sh` [оркестратор]

Деактивация устройства: снимает UUID со всех Entry-нод + устанавливает `status=inactive` + коммитит.
**Запись в реестре сохраняется** (в отличие от `remove.sh`).

| Параметр | Обязательный |
|---|---|
| `--uuid` | да |

Идемпотентен: если устройство уже `inactive` — `exit 0`.
Отказывает: если устройство `archived`.

---

### `devices/get.sh` [атомарный]

Возвращает полный JSON устройства в `stdout`.

| Параметр | Обязательный |
|---|---|
| `--uuid` | да |

---

### `devices/list.sh` [атомарный]

Возвращает JSON-массив устройств пользователя в `stdout`.

| Параметр | Обязательный |
|---|---|
| `--user` | да |

**Возвращает:**
```json
[
  {
    "uuid": "550e8400-...",
    "device": "mobile_006",
    "status": "active",
    "created": "2026-02-20"
  }
]
```

---

### `devices/config.sh` [атомарный]

Генерирует VLESS-ссылки для устройства на основе текущих маршрутов пользователя.

| Параметр | Обязательный |
|---|---|
| `--uuid` | да |

**Возвращает:** JSON-массив VLESS-ссылок в `stdout`. Пустой массив если нет маршрутов.

```json
[
  "vless://550e8400-...@necodate.online:443?type=grpc&security=tls&serviceName=api.v2.rpc...&fp=chrome&alpn=h2#mobile_006"
]
```

---

## nodes/

### `nodes/list-core.sh` [атомарный]

Список активных Core-нод. Используется при одобрении регистрации для выбора ноды.

Параметров нет.

**Возвращает:** JSON-массив в `stdout`.

```json
[
  {"ip": "202.223.48.9", "hostname": "core-node-1", "location": "Japan"}
]
```

---

### `nodes/list-entry.sh` [атомарный]

Список Entry-нод. Поведение зависит от наличия параметра `--user`.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--user` | нет | ID пользователя для фильтрации доступных нод |

**Без `--user`** — все активные Entry-ноды:

```json
[
  {"ip": "195.2.67.202", "hostname": "entry-node-1", "location": "Russia, Moscow"}
]
```

**С `--user <id>`** — Entry-ноды, доступные пользователю через `core_nodes → routes`.
Включает маршрутную информацию, необходимую для вызова `entry/add-client.sh`:

```json
[
  {
    "ip": "195.2.67.202",
    "hostname": "entry-node-1",
    "location": "Russia, Moscow",
    "service_name": "api.v2.rpc.ed43dc57c52e69c0",
    "domain": "necodate.online"
  }
]
```

Используется в: `devices/add.sh`, `devices/remove.sh`, `devices/deactivate.sh`,
а также напрямую ботом при отображении списка нод пользователю.

---

## entry/

### `entry/add-client.sh` [атомарный]

Добавляет UUID клиента в конфиг Xray на Entry-ноде по SSH.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--host` | да | IP Entry-ноды |
| `--uuid` | да | UUID клиента |
| `--service-name` | да | Имя gRPC-сервиса в Xray |
| `--name` | да | Метка клиента (email в Xray) |

Идемпотентен: если UUID уже есть в конфиге — `exit 0`.
Перед применением создаёт резервную копию конфига и валидирует его.
После применения перезапускает Xray и проверяет активность.

---

### `entry/remove-client.sh` [атомарный]

Удаляет UUID клиента из конфига Xray на Entry-ноде по SSH.

| Параметр | Обязательный |
|---|---|
| `--host` | да |
| `--uuid` | да |
| `--service-name` | да |

Идемпотентен: если UUID не найден — `exit 0`.

---

## store/

### `store/commit.sh` [атомарный]

Коммитит текущие изменения в реестре (`git add -A && git commit`).
Если изменений нет — `exit 0` (идемпотентен).

| Параметр | Обязательный |
|---|---|
| `--message` | да |

---

## trial/

Скрипты управления триал-доступом. Подробнее: [docs/trial.md](trial.md).

### `trial/find.sh` [утилита]

Поиск триал-устройств по `telegram_id`. Фильтрует устройства пользователя trial
по маске `^{telegram_id}[0-9]$`.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--telegram-id` | да | Telegram ID |
| `--status` | нет | Фильтр: `active`, `inactive`, `archived` |

**Возвращает:** `[{uuid, device, status, created}]` в `stdout`.

---

### `trial/expire.sh` [оркестратор]

Истечение одного триал-устройства: снятие с Entry-ноды + перевод в `archived`.

| Параметр | Обязательный |
|---|---|
| `--uuid` | да |

Вызывает: `devices/deactivate.sh` → `devices/update.sh --status archived`

---

### `trial/prune.sh` [оркестратор]

Прореживание архивных записей: оставляет только запись с наименьшим digit
(актуальный счётчик лимита), остальные удаляет.

| Параметр | Обязательный |
|---|---|
| `--telegram-id` | да |

Вызывает: `trial/find.sh` → `devices/remove.sh` (для каждого лишнего устройства)

---

### `trial/cleanup.sh` [оркестратор]

Плановая очистка: истекает просроченные устройства + прореживает архив.
Запускается по systemd timer раз в час.

| Параметр | Обязательный | Описание |
|---|---|---|
| `--max-age` | нет | Порог в секундах (по умолчанию 3600) |

Вызывает: `trial/expire.sh` (для каждого просроченного) → `trial/prune.sh` (для каждого telegram_id)

---

## Известные ограничения скриптов

| Ограничение | Влияние |
|---|---|
| `devices/create.sh` требует `user.status=active` | Нельзя добавить устройство `inactive`-пользователю — соответствует политике |
