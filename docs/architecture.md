# Архитектура бота

## Принцип разделения слоёв

**Скрипты** (`scripts` репозиторий) — исполнительный слой:
- Атомарные операции: CRUD в реестре, управление конфигурацией Xray на Entry-нодах
- Не знают о ролях, статусах пользователей и политике доступа
- Валидация данных на уровне скриптов — это осознанное дублирование (safety net)

**Бот** (`SigilGate_bot` репозиторий) — слой политики:
- Определяет роль пользователя (ADMIN / USER / GUEST)
- Контролирует доступ к операциям на основе роли и статуса
- Реализует workflow: последовательность вызовов скриптов с каскадными эффектами
- Не реализует логику операций — только вызывает скрипты

---

## Структура проекта

```
SigilGate_bot/
├── bot/
│   ├── __main__.py          # Инициализация: Bot, Dispatcher, middleware, routers
│   ├── config.py            # Загрузка переменных окружения
│   ├── roles.py             # Определение ролей по telegram_id и реестру
│   ├── runner.py            # Асинхронный запуск скриптов
│   ├── handlers/
│   │   ├── start.py         # /start — приветствие по роли
│   │   ├── reg.py           # /reg — FSM регистрации (GUEST)
│   │   ├── user.py          # /devices и управление устройствами (USER, ADMIN)
│   │   ├── admin.py         # /users и управление пользователями (ADMIN)
│   │   └── guest.py         # fallback для GUEST
│   └── middlewares/
│       └── auth.py          # AuthMiddleware: определение роли и загрузка пользователя
├── docs/                    # Документация
├── .env.example             # Шаблон переменных окружения
└── requirements.txt         # Зависимости: aiogram>=3.0,<4.0
```

---

## Переменные окружения

| Переменная | Обязательная | Описание |
|---|---|---|
| `SIGILGATE_BOT_TOKEN` | да | Токен Telegram-бота |
| `SIGIL_STORE_PATH` | да | Путь к реестру (локальная копия) |
| `SIGIL_SCRIPTS_PATH` | да | Путь к директории скриптов |
| `SIGILGATE_ADMIN_IDS` | нет | Telegram ID администраторов (через запятую) |
| `SIGILGATE_VERBOSE` | нет | Отправлять вывод скриптов в чат (`1`/`true`/`yes`) |

---

## Middleware и роли

### AuthMiddleware

Обрабатывает каждый update. Добавляет в контекст хендлера:
- `data["role"]` — роль пользователя (`Role` enum)
- `data["registry_user"]` — объект пользователя из реестра или `None`

### Определение роли (roles.py)

Приоритет проверок:
1. `telegram_id` в `SIGILGATE_ADMIN_IDS` → **ADMIN**
2. Найдена запись в реестре с совпадающим `telegram_id` → **USER**
3. Иначе → **GUEST**

> **Текущее ограничение:** middleware присваивает роль USER всем,
> у кого есть запись в реестре — независимо от статуса (`inactive`, `archived`).
> Статус пользователя необходимо проверять в хендлерах.

---

## Script Runner (runner.py)

```python
async def run_script(
    cmd: list[str],
    send: SendFunc | None = None,
    verbose: bool = False
) -> tuple[int, str, str]
```

- Запускает скрипт как асинхронный подпроцесс
- Возвращает `(returncode, stdout, stderr)`
- При `verbose=True` отправляет вывод в чат через `send`

---

## Текущее состояние реализации

### Реализовано

| Функция | Handler | Скрипты |
|---|---|---|
| `/start` — приветствие по роли | `start.py` | — |
| `/reg` — полный FSM регистрации | `reg.py` | `users/create.sh`, `store/commit.sh` |
| `/devices` — список устройств | `user.py` | `devices/list.sh` |
| Карточка устройства | `user.py` | `devices/get.sh`, `devices/config.sh` |
| Добавить устройство | `user.py` | `devices/add.sh` |
| Удалить устройство (UI) | `user.py` | `devices/remove.sh` |
| `/users` — список пользователей | `admin.py` | `users/list.sh` |
| Фильтр списка (все / активные) | `admin.py` | `users/list.sh --status active` |
| Карточка пользователя | `admin.py` | `users/get.sh` |

### Заглушки (не реализованы)

| Команда | Handler | Что нужно сделать |
|---|---|---|
| `/status` | `admin.py` | Статус сети: состояние нод, Entry-нод, Xray |
| `/remove_device` | `user.py` | Дублирует удаление через UI; уточнить назначение |

### Критические пробелы (нет реализации)

| Функция | Приоритет | Описание |
|---|---|---|
| Разграничение inactive/archived в роли | высокий | Сейчас оба получают USER — должны получать GUEST |
| Разные сообщения для разных состояний | высокий | pending vs blocked vs archived |
| Уведомление админа о новой заявке | высокий | После `/reg` — сообщение с inline-кнопками |
| Одобрение / отказ / бан регистрации | высокий | Admin FSM с выбором действия и Core-ноды |
| Каскад при блокировке пользователя | высокий | user inactive → все устройства снять с Entry-нод |
| Смена имени устройства | средний | Карточка устройства: кнопка «Переименовать» |
| Управление статусом устройства пользователем | средний | Пока недостижимо из-за ограничений `devices/modify.sh` |
| `/pending` — список ожидающих одобрения | средний | Фильтр `inactive` + `core_nodes=[]` |
| Действия в карточке пользователя (admin) | средний | Сменить статус, назначить Core-ноду |
